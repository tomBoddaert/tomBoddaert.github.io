<h1>Projects</h1>

<script type="module">
  const observerElement = document.getElementById( 'Observer' );
  // For some reason, the JS LSP I'm using doesn't like regex literals in HTML
  const scriptRegex = new RegExp( '<!-- script -->' );

  const projectNames = (
    await fetch( '/projects/index' )
      .then( response => response.text() )
  ).split( /\s/ )
    .filter( entry => entry.length !== 0 );

  const url = new URL( window.location.href );
  const project = url.hash;
  if ( project === '' ) {
    activateObserver();
  } else {
    await loadProject( project.slice( 1 ) );
  }

  async function loadProject( projectName ) {
    const project = await fetch( `/projects/${ projectName }` )
      .then( response => response.text() );

    const projectElement = document.createElement( 'section' );
    projectElement.insertAdjacentHTML( 'afterBegin', project );

    observerElement.insertAdjacentElement( 'beforebegin', projectElement );

    if ( project.match( scriptRegex ) !== null )
      import( `/projects/resources/${ projectName }.js` )
        .then( script => {
          script.run?.call( projectElement );
        } );

    projectElement.setAttribute( 'data-project-name', projectName );
  }

  function activateObserver() {
    let nextProjectIndex = 0;
  
    const observer = new IntersectionObserver( async observation => {
      if ( observation.length === 0 || !observation.at( 0 ).isIntersecting )
        return;
  
      observer.unobserve( observerElement );
  
      const projectName = projectNames[ nextProjectIndex++ ];
      if ( !projectName )
        return;
  
      if ( nextProjectIndex !== 1 ) {
        const line = document.createElement( 'hr' );
        observerElement.insertAdjacentElement( 'beforebegin', line );
      }
  
      await loadProject( projectName );
  
      observer.observe( observerElement );
    } );
    observer.observe( observerElement );
  }
</script>

<hr id="Observer">
